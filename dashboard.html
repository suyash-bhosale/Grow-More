<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Grow More Analytics</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #map {
      height: 400px;
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .gps-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 5;
      background: white;
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-100">

  <nav class="navbar navbar-light bg-white shadow px-4">
    <a href="index.html" class="navbar-brand text-green-600 font-bold">üå± Grow More Analytics</a>
    <button id="logoutBtn" class="btn btn-outline-danger ms-auto">Logout</button>
  </nav>

  <div class="container py-4">
    <h2 class="text-2xl font-bold text-green-700 mb-4">Farmer Dashboard</h2>

    <form id="farmForm" class="bg-white p-4 rounded shadow mb-4">
      <div class="row g-3">
        <div class="col-md-6">
          <label for="farmerName" class="form-label">Farmer Name</label>
          <input type="text" id="farmerName" class="form-control" placeholder="Enter farmer name" required>
        </div>
        <div class="col-md-6">
          <label for="phone" class="form-label">Mobile Number</label>
          <input type="text" id="phone" class="form-control" placeholder="Enter phone number" required>
        </div>
        <div class="col-md-6">
          <label for="district" class="form-label">District</label>
          <input type="text" id="district" class="form-control" placeholder="Enter district" required>
        </div>
        <div class="col-md-6">
          <label for="crop" class="form-label">Crop Name</label>
          <input type="text" id="crop" class="form-control" placeholder="Enter crop name" required>
        </div>
        <div class="col-md-6">
          <label for="sowingDate" class="form-label">Sowing Date</label>
          <input type="date" id="sowingDate" class="form-control" required>
        </div>
     </div>
<button type="submit" class="btn btn-success mt-3" onclick="redirectAfterRegistration(event)">
  Register Field
</button>
</form>

<script>
  // Redirection after field registration
  function redirectAfterRegistration(event) {
    event.preventDefault(); // Prevent default form submission for now

    // OPTIONAL: Add validation or save logic here before redirect

    // Simulate success and redirect
    alert("‚úÖ Field registered successfully!");
    window.location.href = "monitoring.html";
  }
</script>


    <div class="bg-white p-3 rounded shadow">
      <h4 class="text-green-600 font-bold mb-3">Draw Your Farm Boundary</h4>
      <div id="map"></div>
      <button class="btn btn-primary mt-3" id="getCoordinates">Get Coordinates</button>
      <textarea id="coordinatesOutput" class="form-control mt-2" rows="4" placeholder="Boundary coordinates will appear here"></textarea>
    </div>
  </div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBd9tKcTQDLYgjN30FtGT-iYDudJprAKwE&libraries=drawing,geometry,places&callback=initMap" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getFirestore, collection, addDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

    // --------------------------- Updated code -----------------------------

    // Add Your Firebase configuration
    const firebaseConfig = {
    apiKey: "AIzaSyD9sf4FTIPMC4lEUg4qbYqtlJQ2051fUhs",
    authDomain: "grow-more-analytics.firebaseapp.com",
    projectId: "grow-more-analytics",
    storageBucket: "grow-more-analytics.firebasestorage.app",
    messagingSenderId: "71384131834",
    appId: "1:71384131834:web:f1a76a06b8cbe073c28143"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "index.html";
      } catch (error) {
        alert("Logout failed: " + error.message);
      }
    });

    document.getElementById("farmForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const farmerName = document.getElementById("farmerName").value;
  const phone = document.getElementById("phone").value;
  const district = document.getElementById("district").value;
  const crop = document.getElementById("crop").value;
  const sowingDate = document.getElementById("sowingDate").value;
  const coordinates = document.getElementById("coordinatesOutput").value;

  if (!coordinates) {
    alert("Please draw your farm boundary and click 'Get Coordinates' before registering.");
    return;
  }

  // Convert [[lng, lat], [lng, lat], ...] ‚Üí [{lng, lat}, ...]
  const parsedCoords = JSON.parse(coordinates);
  const boundary = parsedCoords.map(([lng, lat]) => ({ lat, lng }));

  const farmData = {
    farmerName,
    phone,
    district,
    crop,
    sowingDate,
    boundary, // Now it's an array of objects, not nested arrays
    createdAt: Timestamp.now()
  };

  try {
  await addDoc(collection(db, "farms"), farmData);
  alert("‚úÖ Farm registered successfully!");

  // ‚úÖ Redirect to Monitoring Page after successful registration
  window.location.href = "monitoring.html";

} catch (error) {
  console.error("Error saving farm:", error);
  alert("‚ùå Error saving farm: " + error.message);
}

});  

// ---------------------------- Updates made till here --------------------------- 

  </script>

// ...existing code...
<script>
  let map, drawingManager, selectedShape;

  window.initMap = function() { // <-- Make it global!
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 19.7515, lng: 75.7139 },
      zoom: 6,
      mapTypeId: "hybrid",
    });

    const gpsButton = document.createElement("button");
    gpsButton.textContent = "üìç My Location";
    gpsButton.classList.add("gps-btn");
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(gpsButton);
    gpsButton.addEventListener("click", () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };
          map.setCenter(pos);
          map.setZoom(16);
          new google.maps.Marker({
            position: pos,
            map: map,
            title: "Your Location",
          });
        });
      } else {
        alert("Geolocation is not supported by your browser.");
      }
    });

    drawingManager = new google.maps.drawing.DrawingManager({
      drawingMode: google.maps.drawing.OverlayType.POLYGON,
      drawingControl: true,
      drawingControlOptions: {
        position: google.maps.ControlPosition.TOP_CENTER,
        drawingModes: ["polygon"],
      },
      polygonOptions: {
        fillColor: "#00FF00",
        fillOpacity: 0.2,
        strokeWeight: 2,
        clickable: true,
        editable: true,
        zIndex: 1,
      },
    });
    drawingManager.setMap(map);

    google.maps.event.addListener(drawingManager, "overlaycomplete", function (e) {
      if (selectedShape) {
        selectedShape.setMap(null);
      }
      selectedShape = e.overlay;
    });

    document.getElementById("getCoordinates").addEventListener("click", () => {
      if (!selectedShape) {
        alert("Draw your farm boundary first!");
        return;
      }
      const path = selectedShape.getPath();
      const coordinates = [];
      for (let i = 0; i < path.getLength(); i++) {
        const latLng = path.getAt(i);
        coordinates.push([latLng.lng(), latLng.lat()]);
      }
      document.getElementById("coordinatesOutput").value = JSON.stringify(coordinates, null, 2);
    });
  }
</script>
// ...existing code...
</body>
</html>
