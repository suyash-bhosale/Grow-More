<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Farming Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Styles */
        :root {
            --primary-color: #4caf50; /* Green */
            --secondary-color: #81c784; /* Light Green */
            --accent-color: #ffb74d; /* Orange */
            --dark-color: #1b5e20; /* Dark Green */
            --light-color: #e8f5e9; /* Light Background */
            --text-color: #263238; /* Dark Text */
            --warning-color: #ff5722; /* Red */
            --success-color: #4caf50; /* Green */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-color);
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Animated Background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: linear-gradient(45deg, rgba(76, 175, 80, 0.6), rgba(129, 199, 132, 0.4));
            border-radius: 50%;
            pointer-events: none;
            animation: float 8s infinite ease-in-out;
        }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg) scale(0.5); opacity: 0; }
        }

        /* Main Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: slideDown 1s ease-out;
            backdrop-filter: blur(10px);
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        header h1 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 3rem;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        header p {
            color: var(--text-color);
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
            transition: left 0.5s;
        }

        .card:hover::before {
            left: 100%;
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(76, 175, 80, 0.2);
        }

        .card-title {
            font-size: 1.4rem;
            color: var(--primary-color);
            font-weight: 700;
        }

        .card-icon {
            font-size: 2rem;
            color: var(--secondary-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .status-good {
            background: linear-gradient(45deg, #e8f5e9, #c8e6c9);
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        .status-average {
            background: linear-gradient(45deg, #fff8e1, #ffecb3);
            color: #ffa000;
            border: 2px solid #ffa000;
        }

        .status-poor {
            background: linear-gradient(45deg, #ffebee, #ffcdd2);
            color: var(--warning-color);
            border: 2px solid var(--warning-color);
        }

        /* AI Advisory Section */
        #ai-advisory-container {
            grid-column: 1 / -1;
        }

        #ai-advisory {
            background: linear-gradient(135deg, #f5f5f5, #e8f5e9);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            min-height: 200px;
            border-left: 6px solid var(--accent-color);
            animation: fadeIn 1s ease-in;
            position: relative;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-align: center;
            border: none;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), #66bb6a);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, var(--secondary-color), #a5d6a7);
            color: white;
            box-shadow: 0 4px 15px rgba(129, 199, 132, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(129, 199, 132, 0.4);
        }

        .btn-accent {
            background: linear-gradient(45deg, var(--accent-color), #ffcc02);
            color: var(--text-color);
            box-shadow: 0 4px 15px rgba(255, 183, 77, 0.3);
        }

        .btn-accent:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 183, 77, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #e57373);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.2);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(76, 175, 80, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Value Highlight */
        .value-highlight {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        /* Last Update */
        #last-update {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Map Container */
        #map {
            height: 400px;
            border-radius: 15px;
            margin-top: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 30px 0;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        /* Floating WhatsApp Button */
        .whatsapp-float {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(45deg, #25D366, #128C7E);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            box-shadow: 0 8px 20px rgba(37, 211, 102, 0.3);
            z-index: 100;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
            40%, 43% { transform: translateY(-10px); }
            70% { transform: translateY(-5px); }
            90% { transform: translateY(-2px); }
        }

        .whatsapp-float:hover {
            transform: scale(1.15);
            box-shadow: 0 12px 30px rgba(37, 211, 102, 0.5);
        }

        /* Farm Info Display */
        .farm-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
        }

        .farm-info h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .farm-info p {
            margin: 5px 0;
            color: var(--text-color);
        }

        /* Back Button */
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2.2rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .back-btn {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 20px;
            }
        }

        /* Success Animation */
        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(76, 175, 80, 0.6); }
            100% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Error Message */
        .error-message {
            background: linear-gradient(45deg, #ffebee, #ffcdd2);
            color: var(--warning-color);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--warning-color);
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="particles"></div>
    
    <!-- Back Button -->
    <button class="btn btn-danger back-btn" onclick="goBackToDashboard()">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
    </button>
    
    <div class="container">
        <header>
            <h1>üå± Smart Farming Dashboard</h1>
            <p>Real-time satellite monitoring and AI advisory for optimal farming</p>
            <p>Last updated: <span id="last-update">--:--:--</span></p>
        </header>
        
        <div class="dashboard-grid">
            <!-- Farm Information Card -->
            <div class="card" id="farm-info-card">
                <div class="card-header">
                    <span class="card-title">Farm Information</span>
                    <span class="card-icon"><i class="fas fa-info-circle"></i></span>
                </div>
                <div id="farm-info-display">
                    <div class="loading"></div> Loading farm information...
                </div>
            </div>

            <!-- Map Section -->
            <div class="card" id="map-card">
                <div class="card-header">
                    <span class="card-title">Farm Location</span>
                    <span class="card-icon"><i class="fas fa-map-marked-alt"></i></span>
                </div>
                <div id="map"></div>
            </div>

            <!-- Vegetation Indices Cards -->
            <div class="card" id="ndvi-card">
                <div class="card-header">
                    <span class="card-title">NDVI (Vegetation Health)</span>
                    <span class="card-icon"><i class="fas fa-leaf"></i></span>
                </div>
                <p>Normalized Difference Vegetation Index measures plant health and density.</p>
                <div class="value-highlight" id="ndvi-value">--</div>
                <div class="status-indicator" id="ndvi-status">Analyzing...</div>
            </div>
            
            <div class="card" id="gndvi-card">
                <div class="card-header">
                    <span class="card-title">GNDVI (Chlorophyll)</span>
                    <span class="card-icon"><i class="fas fa-seedling"></i></span>
                </div>
                <p>Green Normalized Difference Vegetation Index indicates chlorophyll content.</p>
                <div class="value-highlight" id="gndvi-value">--</div>
                <div class="status-indicator" id="gndvi-status">Analyzing...</div>
            </div>
            
            <div class="card" id="ndre-card">
                <div class="card-header">
                    <span class="card-title">NDRE (Nitrogen)</span>
                    <span class="card-icon"><i class="fas fa-flask"></i></span>
                </div>
                <p>Normalized Difference Red Edge Index is sensitive to nitrogen content.</p>
                <div class="value-highlight" id="ndre-value">--</div>
                <div class="status-indicator" id="ndre-status">Analyzing...</div>
            </div>
            
            <div class="card" id="msi-card">
                <div class="card-header">
                    <span class="card-title">MSI (Water Stress)</span>
                    <span class="card-icon"><i class="fas fa-tint"></i></span>
                </div>
                <p>Moisture Stress Index measures canopy water content and stress.</p>
                <div class="value-highlight" id="msi-value">--</div>
                <div class="status-indicator" id="msi-status">Analyzing...</div>
            </div>
            
            <!-- AI Advisory -->
            <div class="card" id="ai-advisory-container">
                <div class="card-header">
                    <span class="card-title">ü§ñ AI Agricultural Advisor</span>
                    <span class="card-icon"><i class="fas fa-brain"></i></span>
                </div>
                <p>Advanced satellite-based analysis and recommendations for your farm:</p>
                <div id="ai-advisory">Welcome to your Smart Farming Dashboard! Loading farm data and preparing satellite analysis...</div>
                <div class="form-group">
                    <label for="gemini-api-key">üîë Gemini API Key (Optional - for enhanced AI analysis):</label>
                    <input type="text" id="gemini-api-key" placeholder="Enter your Gemini API key for advanced AI recommendations">
                </div>
                <div class="button-group">
                    <button id="analyze-btn" class="btn btn-primary">
                        <span id="analyze-text"><i class="fas fa-satellite-dish"></i> Analyze Satellite Data</span>
                    </button>
                    <button id="download-report" class="btn btn-secondary">
                        <i class="fas fa-file-download"></i> Download Report
                    </button>
                    <button id="share-whatsapp" class="btn btn-accent">
                        <i class="fab fa-whatsapp"></i> Share Analysis
                    </button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>¬© 2024 Smart Farming Solutions | Pune, Maharashtra, India</p>
            <p>üõ∞Ô∏è Powered by Sentinel-2 satellite imagery | Data updates every 12 hours</p>
        </footer>
    </div>
    
    <!-- Floating WhatsApp Button -->
    <a href="https://wa.me/?text=Check out this Smart Farming Dashboard for real-time crop monitoring!" class="whatsapp-float" target="_blank">
        <i class="fab fa-whatsapp"></i>
    </a>

    <script type="module">
        // Firebase imports and configuration
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9sf4FTIPMC4lEUg4qbYqtlJQ2051fUhs",
            authDomain: "grow-more-analytics.firebaseapp.com",
            projectId: "grow-more-analytics",
            storageBucket: "grow-more-analytics.firebasestorage.app",
            messagingSenderId: "71384131834",
            appId: "1:71384131834:web:f1a76a06b8cbe073c28143"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global variables
        let map;
        let farmData = {};
        let currentFarmInfo = null;

        // Check authentication and load farm data
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadLatestFarmData();
            } else {
                // Redirect to login if not authenticated
                window.location.href = "index.html";
            }
        });

        // Load the latest farm data from Firestore
        async function loadLatestFarmData() {
            try {
                const farmsRef = collection(db, "farms");
                const q = query(farmsRef, orderBy("createdAt", "desc"), limit(1));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const farmDoc = querySnapshot.docs[0];
                    currentFarmInfo = { id: farmDoc.id, ...farmDoc.data() };
                    
                    // Display farm information
                    displayFarmInfo(currentFarmInfo);
                    
                    // Initialize map with farm boundary
                    initMapWithFarmBoundary(currentFarmInfo.boundary);
                    
                    // Show success message
                    document.getElementById('ai-advisory').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-check-circle fa-3x" style="color: var(--success-color); margin-bottom: 15px;"></i>
                            <h3>‚úÖ Farm Data Loaded Successfully!</h3>
                            <p>Farm registered for <strong>${currentFarmInfo.farmerName}</strong> in ${currentFarmInfo.district}</p>
                            <p>Crop: <strong>${currentFarmInfo.crop}</strong> | Sowing Date: <strong>${new Date(currentFarmInfo.sowingDate).toLocaleDateString()}</strong></p>
                            <div style="margin-top: 20px;">
                                <p>Click "Analyze Satellite Data" to get AI-powered insights for your farm.</p>
                            </div>
                        </div>
                    `;
                } else {
                    // No farm data found
                    document.getElementById('farm-info-display').innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i> No farm data found. Please register your farm first.
                            <br><br>
                            <button class="btn btn-primary" onclick="goBackToDashboard()">Go to Dashboard</button>
                        </div>
                    `;
                    
                    document.getElementById('ai-advisory').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-exclamation-triangle fa-3x" style="color: var(--warning-color); margin-bottom: 15px;"></i>
                            <h3>‚ö†Ô∏è No Farm Data Found</h3>
                            <p>Please register your farm first to access monitoring features.</p>
                            <button class="btn btn-primary" onclick="goBackToDashboard()" style="margin-top: 15px;">
                                <i class="fas fa-plus"></i> Register Farm
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error("Error loading farm data:", error);
                document.getElementById('farm-info-display').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i> Error loading farm data: ${error.message}
                        <br><br>
                        <button class="btn btn-primary" onclick="location.reload()">Retry</button>
                    </div>
                `;
            }
        }

        // Display farm information
        function displayFarmInfo(farmInfo) {
            const farmInfoDisplay = document.getElementById('farm-info-display');
            const sowingDate = new Date(farmInfo.sowingDate).toLocaleDateString('en-IN');
            const createdDate = farmInfo.createdAt.toDate().toLocaleDateString('en-IN');
            
            farmInfoDisplay.innerHTML = `
                <div class="farm-info">
                    <h4><i class="fas fa-user"></i> ${farmInfo.farmerName}</h4>
                    <p><i class="fas fa-phone"></i> <strong>Phone:</strong> ${farmInfo.phone}</p>
                    <p><i class="fas fa-map-marker-alt"></i> <strong>District:</strong> ${farmInfo.district}</p>
                    <p><i class="fas fa-seedling"></i> <strong>Crop:</strong> ${farmInfo.crop}</p>
                    <p><i class="fas fa-calendar-alt"></i> <strong>Sowing Date:</strong> ${sowingDate}</p>
                    <p><i class="fas fa-clock"></i> <strong>Registered:</strong> ${createdDate}</p>
                    <p><i class="fas fa-vector-square"></i> <strong>Boundary Points:</strong> ${farmInfo.boundary.length} coordinates</p>
                </div>
            `;
        }

        // Initialize map with farm boundary
        function initMapWithFarmBoundary(boundary) {
            if (!boundary || boundary.length === 0) {
                initMap(); // Fall back to default map
                return;
            }

            // Convert Firebase boundary format to Leaflet format
            const leafletBoundary = boundary.map(point => [point.lat, point.lng]);
            
            // Calculate center of the boundary
            const centerLat = boundary.reduce((sum, point) => sum + point.lat, 0) / boundary.length;
            const centerLng = boundary.reduce((sum, point) => sum + point.lng, 0) / boundary.length;

            // Initialize map
            map = L.map('map').setView([centerLat, centerLng], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add farm boundary polygon
            const farmPolygon = L.polygon(leafletBoundary, {
                color: '#4caf50',
                weight: 3,
                fillColor: '#81c784',
                fillOpacity: 0.3
            }).addTo(map);

            // Calculate area (approximate)
            const area = calculatePolygonArea(boundary);
            
            farmPolygon.bindPopup(`
                <div style="text-align: center;">
                    <h4>${currentFarmInfo.farmerName}'s Farm</h4>
                    <p><strong>Crop:</strong> ${currentFarmInfo.crop}</p>
                    <p><strong>Area:</strong> ~${area.toFixed(2)} hectares</p>
                    <p><strong>District:</strong> ${currentFarmInfo.district}</p>
                </div>
            `);

            // Add farm center marker
            L.marker([centerLat, centerLng], {
                icon: L.divIcon({
                    html: '<i class="fas fa-tractor" style="color: #4caf50; font-size: 20px;"></i>',
                    className: 'custom-div-icon',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map).bindPopup(`
                <b>Farm Center</b><br>
                ${currentFarmInfo.farmerName}<br>
                ${currentFarmInfo.district}
            `);

            // Fit map to show the entire farm boundary
            map.fitBounds(farmPolygon.getBounds(), { padding: [20, 20] });
        }

        // Calculate polygon area (approximate using Shoelace formula)
        function calculatePolygonArea(coordinates) {
            if (coordinates.length < 3) return 0;
            
            let area = 0;
            const n = coordinates.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += coordinates[i].lng * coordinates[j].lat;
                area -= coordinates[j].lng * coordinates[i].lat;
            }
            
            area = Math.abs(area) / 2;
            
            // Convert to hectares (very rough approximation)
            // 1 degree ‚âà 111 km, so 1 square degree ‚âà 12321 km¬≤ ‚âà 1,232,100 hectares
            return area * 1232100;
        }

        // Initialize particles background
        function createParticles() {
            const particlesContainer = document.querySelector('.particles');
            for (let i = 0; i < 60; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.width = Math.random() * 6 + 3 + 'px';
                particle.style.height = particle.style.width;
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = Math.random() * 6 + 8 + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Initialize default map (fallback)
        function initMap() {
            map = L.map('map').setView([18.5204, 73.8567], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Default farm boundary polygon
            const defaultBoundary = [
                [18.5180, 73.8540],
                [18.5230, 73.8540],
                [18.5230, 73.8590],
                [18.5180, 73.8590]
            ];

            L.polygon(defaultBoundary, {
                color: '#4caf50',
                weight: 3,
                fillColor: '#81c784',
                fillOpacity: 0.3
            }).addTo(map).bindPopup('Default Farm Area (Please register your farm for accurate boundaries)');

            // Add default center marker
            L.marker([18.5204, 73.8567], {
                icon: L.divIcon({
                    html: '<i class="fas fa-tractor" style="color: #4caf50; font-size: 20px;"></i>',
                    className: 'custom-div-icon',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map).bindPopup('<b>Default Location</b><br>Pune, Maharashtra');
        }

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-IN', { 
                timeZone: 'Asia/Kolkata',
                hour12: true 
            });
            document.getElementById('last-update').textContent = timeString;
        }

        // Simulate satellite data analysis
        function simulateSatelliteAnalysis() {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const data = {
                        ndvi: (Math.random() * 0.4 + 0.5).toFixed(3), // 0.5-0.9
                        gndvi: (Math.random() * 0.3 + 0.4).toFixed(3), // 0.4-0.7
                        ndre: (Math.random() * 0.2 + 0.3).toFixed(3), // 0.3-0.5
                        msi: (Math.random() * 0.5 + 0.5).toFixed(3)  // 0.5-1.0
                    };
                    resolve(data);
                }, 2000);
            });
        }

        // Update vegetation indices
        function updateVegetationIndices(data) {
            // NDVI
            document.getElementById('ndvi-value').textContent = data.ndvi;
            const ndviStatus = data.ndvi > 0.7 ? 'status-good' : data.ndvi > 0.5 ? 'status-average' : 'status-poor';
            const ndviText = data.ndvi > 0.7 ? 'Excellent Health' : data.ndvi > 0.5 ? 'Good Health' : 'Needs Attention';
            document.getElementById('ndvi-status').className = `status-indicator ${ndviStatus}`;
            document.getElementById('ndvi-status').textContent = ndviText;
            
            // GNDVI
            document.getElementById('gndvi-value').textContent = data.gndvi;
            const gndviStatus = data.gndvi > 0.6 ? 'status-good' : data.gndvi > 0.4 ? 'status-average' : 'status-poor';
            const gndviText = data.gndvi > 0.6 ? 'High Chlorophyll' : data.gndvi > 0.4 ? 'Moderate Chlorophyll' : 'Low Chlorophyll';
            document.getElementById('gndvi-status').className = `status-indicator ${gndviStatus}`;
            document.getElementById('gndvi-status').textContent = gndviText;
            
            // NDRE
            document.getElementById('ndre-value').textContent = data.ndre;
            const ndreStatus = data.ndre > 0.4 ? 'status-good' : data.ndre > 0.3 ? 'status-average' : 'status-poor';
            const ndreText = data.ndre > 0.4 ? 'Adequate Nitrogen' : data.ndre > 0.3 ? 'Moderate Nitrogen' : 'Low Nitrogen';
            document.getElementById('ndre-status').className = `status-indicator ${ndreStatus}`;
            document.getElementById('ndre-status').textContent = ndreText;
            
            // MSI
            document.getElementById('msi-value').textContent = data.msi;
            const msiStatus = data.msi < 0.7 ? 'status-good' : data.msi < 0.9 ? 'status-average' : 'status-poor';
            const msiText = data.msi < 0.7 ? 'Low Water Stress' : data.msi < 0.9 ? 'Moderate Water Stress' : 'High Water Stress';
            document.getElementById('msi-status').className = `status-indicator ${msiStatus}`;
            document.getElementById('msi-status').textContent = msiText;
        }

        // Generate AI advisory
        function generateAIAdvisory(data) {
            const advisory = document.getElementById('ai-advisory');
            
            let recommendations = '<h3>üéØ AI-Powered Farm Analysis & Recommendations</h3><br>';
            
            if (currentFarmInfo) {
                recommendations += `<div style="background: linear-gradient(45deg, #e3f2fd, #bbdefb); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #2196f3;">
                    <strong>üìç Farm Details:</strong><br>
                    Farmer: ${currentFarmInfo.farmerName} | Crop: ${currentFarmInfo.crop} | District: ${currentFarmInfo.district}<br>
                    Sowing Date: ${new Date(currentFarmInfo.sowingDate).toLocaleDateString('en-IN')}
                </div>`;
            }
            
            // Overall health assessment
            const overallHealth = (parseFloat(data.ndvi) + parseFloat(data.gndvi) + parseFloat(data.ndre) + (1 - parseFloat(data.msi))) / 4;
            
            if (overallHealth > 0.7) {
                recommendations += '<div style="background: linear-gradient(45deg, #e8f5e9, #c8e6c9); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #4caf50;"><strong>üåü Excellent Farm Health!</strong><br>Your crops are thriving with optimal vegetation indices.</div>';
            } else if (overallHealth > 0.5) {
                recommendations += '<div style="background: linear-gradient(45deg, #fff8e1, #ffecb3); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffa000;"><strong>‚ö†Ô∏è Moderate Farm Health</strong><br>Some areas need attention for optimal growth.</div>';
            } else {
                recommendations += '<div style="background: linear-gradient(45deg, #ffebee, #ffcdd2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #f44336;"><strong>üö® Farm Needs Immediate Attention</strong><br>Multiple indices indicate stress conditions.</div>';
            }
            
            // Specific recommendations
            recommendations += '<h4>üìã Detailed Recommendations:</h4><ul style="margin-left: 20px; margin-top: 10px;">';
            
            if (data.ndvi < 0.6) {
                recommendations += '<li>üå± <strong>Vegetation Health:</strong> Consider soil testing and nutrient supplementation</li>';
            }
            
            if (data.gndvi < 0.5) {
                recommendations += '<li>üçÉ <strong>Chlorophyll Levels:</strong> Apply foliar nitrogen spray or organic compost</li>';
            }
            
            if (data.ndre < 0.35) {
                recommendations += '<li>üíß <strong>Nitrogen Deficiency:</strong> Immediate nitrogen fertilization recommended</li>';
            }
            
            if (data.msi > 0.8) {
                recommendations += '<li>üí¶ <strong>Water Stress:</strong> Increase irrigation frequency and check drainage</li>';
            }
            
            recommendations += '</ul>';
            
            // Crop-specific recommendations
            if (currentFarmInfo && currentFarmInfo.crop) {
                recommendations += `<br><h4>üåæ ${currentFarmInfo.crop}-Specific Recommendations:</h4>`;
                recommendations += `<p>Based on your ${currentFarmInfo.crop} crop and current growth stage:</p>`;
                recommendations += '<ul style="margin-left: 20px;"><li>Monitor for crop-specific pests and diseases</li><li>Adjust fertilization schedule based on crop growth stage</li><li>Consider market timing for optimal harvest</li></ul>';
            }
            
            // Weather-based recommendations
            recommendations += '<br><h4>üå§Ô∏è Weather-Based Actions:</h4>';
            recommendations += `<p>Based on current ${currentFarmInfo ? currentFarmInfo.district : 'local'} weather conditions:</p>`;
            recommendations += '<ul style="margin-left: 20px;"><li>Monitor for pest activity due to humidity levels</li><li>Adjust irrigation timing to early morning hours</li><li>Prepare for seasonal crop rotation planning</li></ul>';
            
            advisory.innerHTML = recommendations;
        }

        // Download report function
        function downloadReport() {
            let reportContent = `
Smart Farming Analysis Report
Generated: ${new Date().toLocaleString('en-IN')}
`;

            if (currentFarmInfo) {
                reportContent += `
=== FARM INFORMATION ===
Farmer Name: ${currentFarmInfo.farmerName}
Phone: ${currentFarmInfo.phone}
District: ${currentFarmInfo.district}
Crop: ${currentFarmInfo.crop}
Sowing Date: ${new Date(currentFarmInfo.sowingDate).toLocaleDateString('en-IN')}
Registration Date: ${currentFarmInfo.createdAt.toDate().toLocaleDateString('en-IN')}
Boundary Points: ${currentFarmInfo.boundary.length} coordinates
`;
            }

            reportContent += `
=== VEGETATION INDICES ===
NDVI (Vegetation Health): ${farmData.ndvi || 'N/A'}
GNDVI (Chlorophyll): ${farmData.gndvi || 'N/A'}
NDRE (Nitrogen): ${farmData.ndre || 'N/A'}
MSI (Water Stress): ${farmData.msi || 'N/A'}

=== AI RECOMMENDATIONS ===
${document.getElementById('ai-advisory').innerText}

=== CONTACT ===
For technical support: support@smartfarming.com
WhatsApp: +91 9876543210

¬© Smart Farming Solutions - Grow More Analytics
            `;
            
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `farm-analysis-${currentFarmInfo ? currentFarmInfo.farmerName.replace(/\s+/g, '-') : 'report'}-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Share on WhatsApp
        function shareOnWhatsApp() {
            let message = `üå± Smart Farming Analysis Report\n`;
            
            if (currentFarmInfo) {
                message += `üë®‚Äçüåæ Farmer: ${currentFarmInfo.farmerName}
üìç Location: ${currentFarmInfo.district}
üåæ Crop: ${currentFarmInfo.crop}
üìÖ Date: ${new Date().toLocaleDateString('en-IN')}

üìä Current Farm Status:`;
            } else {
                message += `üìÖ Date: ${new Date().toLocaleDateString('en-IN')}

üìä Farm Analysis:`;
            }

            message += `
‚Ä¢ NDVI (Health): ${farmData.ndvi || 'Analyzing...'}
‚Ä¢ GNDVI (Chlorophyll): ${farmData.gndvi || 'Analyzing...'}
‚Ä¢ NDRE (Nitrogen): ${farmData.ndre || 'Analyzing...'}
‚Ä¢ MSI (Water Stress): ${farmData.msi || 'Analyzing...'}

ü§ñ AI Analysis: Farm health monitoring complete!

üîó Grow More Analytics - Smart Farming Solutions
üí¨ Contact: +91 9876543210`;

            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
        }

        // Main analysis function
        async function runAnalysis() {
            const analyzeBtn = document.getElementById('analyze-btn');
            const analyzeText = document.getElementById('analyze-text');
            
            // Start analysis
            analyzeBtn.disabled = true;
            analyzeText.innerHTML = '<div class="loading"></div>Analyzing satellite data...';
            
            try {
                // Simulate satellite data fetch
                farmData = await simulateSatelliteAnalysis();
                
                // Update UI with results
                updateVegetationIndices(farmData);
                generateAIAdvisory(farmData);
                
                // Success animation
                document.querySelector('#ai-advisory-container').classList.add('success-animation');
                setTimeout(() => {
                    document.querySelector('#ai-advisory-container').classList.remove('success-animation');
                }, 600);
                
                // Update button
                analyzeText.innerHTML = '<i class="fas fa-check-circle"></i> Analysis Complete';
                setTimeout(() => {
                    analyzeText.innerHTML = '<i class="fas fa-satellite-dish"></i> Re-analyze Data';
                    analyzeBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Analysis failed:', error);
                analyzeText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Analysis Failed - Try Again';
                analyzeBtn.disabled = false;
            }
        }

        // Enhanced AI advisory with Gemini API (if provided)
        async function enhancedAIAnalysis(apiKey, data) {
            if (!apiKey) return null;
            
            try {
                const cropInfo = currentFarmInfo ? `for ${currentFarmInfo.crop} crop` : '';
                const locationInfo = currentFarmInfo ? `in ${currentFarmInfo.district}, Maharashtra` : 'in Maharashtra';
                
                const prompt = `As an agricultural AI expert, analyze this satellite data for a farm ${locationInfo}:
                NDVI: ${data.ndvi}
                GNDVI: ${data.gndvi}
                NDRE: ${data.ndre}
                MSI: ${data.msi}
                ${cropInfo}
                
                Provide specific, actionable recommendations for:
                1. Immediate actions needed
                2. Fertilization schedule
                3. Irrigation optimization
                4. Pest/disease prevention
                5. Crop rotation suggestions
                
                Keep response concise and practical for Indian farming conditions.`;
                
                // Note: This is a placeholder for Gemini API integration
                // In a real implementation, you would make an API call here
                return "Enhanced AI analysis would be integrated here with your Gemini API key.";
                
            } catch (error) {
                console.error('Enhanced AI analysis failed:', error);
                return null;
            }
        }

        // Go back to dashboard function
        window.goBackToDashboard = function() {
            window.location.href = "dashboard.html";
        };

        // Initialize dashboard
        function initDashboard() {
            createParticles();
            updateTimestamp();
            
            // Update timestamp every minute
            setInterval(updateTimestamp, 60000);
            
            // Event listeners
            document.getElementById('analyze-btn').addEventListener('click', runAnalysis);
            document.getElementById('download-report').addEventListener('click', downloadReport);
            document.getElementById('share-whatsapp').addEventListener('click', shareOnWhatsApp);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        runAnalysis();
                        break;
                    case 'd':
                        e.preventDefault();
                        downloadReport();
                        break;
                    case 's':
                        e.preventDefault();
                        shareOnWhatsApp();
                        break;
                    case 'b':
                        e.preventDefault();
                        goBackToDashboard();
                        break;
                }
            }
        });

        // Add tooltips for better UX
        function addTooltips() {
            const tooltipElements = [
                { id: 'ndvi-card', text: 'NDVI values: 0.8-1.0 = Excellent, 0.6-0.8 = Good, 0.4-0.6 = Fair, <0.4 = Poor' },
                { id: 'gndvi-card', text: 'GNDVI focuses on chlorophyll content - higher values indicate healthier plants' },
                { id: 'ndre-card', text: 'NDRE is sensitive to nitrogen stress - lower values may indicate nitrogen deficiency' },
                { id: 'msi-card', text: 'MSI measures water stress - higher values indicate more water stress' }
            ];
            
            tooltipElements.forEach(item => {
                const element = document.getElementById(item.id);
                if (element) {
                    element.title = item.text;
                }
            });
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();
            addTooltips();
        });

        // Add smooth scrolling for better UX
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Progressive Web App features
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }

        // Add intersection observer for animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animation = 'fadeIn 0.8s ease-out forwards';
                }
            });
        }, observerOptions);

        // Observe all cards
        setTimeout(() => {
            document.querySelectorAll('.card').forEach(card => {
                observer.observe(card);
            });
        }, 100);

    </script>
</body>
</html>